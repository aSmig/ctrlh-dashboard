<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>PDX Hackerspace Dashboard</title>
<meta name="viewport" content="width=device-width">
<meta name="description" content="Portland's Hackerspace. Check out our website calendar for our weekly open house and all other events open to the public.">

<link rel="stylesheet" href="https://pdxhackerspace.org/style.css" integrity="sha384-e5tu+wTFdksi4IWd3RtMTgkMMqPJDSauUgAeGK4v+7ng6MPf60XceelTuC1iNnh/" crossorigin="anonymous">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<!-- Custom Fonts -->
<link rel="stylesheet" href="https://pdxhackerspace.org/css/font-awesome/css/font-awesome.min.css" integrity="sha384-X7L1bhgb36bF1iFvaqvhgpaGpayKM+vXNNYRlF89BFA5s3vi1qZ8EX9086RlZjy1" crossorigin="anonymous">

<style>
html {
  font-size: 16px;
}

.hr-green {
  border-color: green !important;
}

time, #last_updated {
  font-size: small;
  font-style: italic;
}
</style>

</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12 text-center">
	<h1>PDX Hackerspace Dashboard</h1>
	<hr class="star-primary">
        <p id='last_updated'>Last updated: <span id='last_updated_container'></span></p>
      </div>
    </div>

    <div class='row'>

      <div class='col-lg-8'>

        <div class='row'>
          <div class='col'>
            <h2><a href='graph.html?uuid=691faad6-bad4-4c87-838b-091ce650e4d4'>Weather</a></h2>
            <p id='weather'>
            </p>
            <p id='aqi'>
            </p>
          </div><!-- col -->
          <div class='col'>
            <h2>Trimet</h2>
            <p id='trimet'>
            </p>
          </div><!-- col -->
        </div><!-- row -->

        <div class='row'>
          <div class='col'>
	    <h2>Rooms</h2>
	<table class='table table-striped'>
	  <tr>
	    <th>Room</th><th>Temp</th><th>Hum</th><th>Occ?</th><th>Watts</th>
	  </tr>
	  <tr>
	    <td>Unit 1</td><td></td><td></td><td></td><td></td>
	  </tr>
	  <tr>
	    <td><a href='graph.html?uuid=04001f9a-122b-4045-84f4-69b7c7318250'>Unit 2</a></td><td><span id='unit2_temperature'></span>°C</td><td><span id='unit2_humidity'></span>%</td><td><span id='unit2_occupied'></span></td>
	  </tr>
	  <tr>
	    <td>Electronics Lab</td><td><span id='electronics_lab_temperature'></span></td><td><span id='electronics_lab_humidity'></span></td><td><span id='electronics_lab_occupied'></span></td>
	  </tr>
	  <tr>
	    <td>Unit 3</td><td></td><td></td><td></td><td></td>
	  </tr>
	  <tr>
	    <td><a href='graph.html?uuid=067746e8-7a2f-4f6e-bb59-e1b2043b37f3'>Slytherin</a></td><td><span id='slytherin_temperature'></span>°C</td><td><span id='slytherin_humidity'></span>%</td><td><span id='slytherin_occupied'></span></td>
	  </tr>
	  <tr>
	    <td>Hydroponics</td><td></td><td></td><td></td><td></td>
	  </tr>
	  <tr>
	    <td>Garden</td><td></td><td></td><td></td><td></td>
	  </tr>
	</table>
          </div><!-- col -->
          <div class='col'>
	    <h2>Facilities</h2>
	<table class='table table-striped'>
	  <tr>
	    <td rowspan=2><a href='graph.html?uuid=7db061e9-d73a-47a0-a4ab-f3d097da5504'>Network</a></td>
	    <td>rx: <span id='network_rx'></span>ps</td>
	    <td>tx: <span id='network_tx'></span>ps</td>
	  </tr>
          <tr>
	    <td>active hosts</td><td id='network_active'></td>
	  </tr>
	  <tr>
	    <td>^H Sign</td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>Buckets</td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>Vendo LEDs</td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>LED strip</td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>Unit 2 Projector</td>
	    <td id="unit2_projector_status"></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>Unit 3 Projector</td>
	    <td id="unit3_projector_status"></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td><a href='graph.html?uuid=4cf5765b-6a1a-4f05-879f-1285e092beb3'>Vendo</a></td>
	    <td><span id='vendo-temperature'></span>°C</td>
	    <td><span id='vendo-humidity'></span>%</td>
	  </tr>
	  <tr>
	    <td>Grill</td>
	    <td></td>
	    <td></td>
	  </tr>
	  <tr>
	    <td>Freezer</td>
	    <td></td>
	    <td></td>
	  </tr>
	</table>

          </div><!-- col -->
        </div><!-- row -->

        <div class='row'>
          <div class='col'>
	    <h2><a href='graph.html?uuid=03bf9198-1fe5-480f-b3c7-efdf628d2b8a'>Access</a></h2>
            <ul id="access" class="list-group list-group-flush">
	    </ul>
          </div><!-- col -->
          <div class='col'>
	    <h2><a href='graph.html?uuid=4f265e2c-3c08-4635-8e50-8400d5294c29'>Printers</a></h>
	    <p>
              <h5 class='printer-name'></h5>
	      <p class='printer-status'></p>
	      <p><span class='pages-printed'></span> pages printed</p>
            </p>
	    <div id='dremel-cam'>
	    <h5><a href='graph.html?uuid=7bfff065-f2e8-406d-b8d1-734a84c4c222'>Dremel</a></h5>
	      <h6 id='dremel-status'></h6>
  	      <div id='dremel-job' style='display: none'>
		<ul>
		  <li>Filename: <span id='dremel-filename'></span></li>
		  <li>Progress: <span id='dremel-progress'><span>%</li>
		  <li>Time Remaining: <span id='dremel-print-time'></span> of <span id='dremel-print-time-remaining'></span> sec</li>
                </ul>
	      </div>
	      <table class='table'>
		<tr><th>temp</th><th>actual</th><th>target</th></tr>
		<tr><td>tool</td><td><span id='dremel-tool-temp'></span>°C</td><td><span id='dremel-tool-temp-target'></span>°C</td></tr>
		<tr><td>bed</td><td><span id='dremel-bed-temp'></span>°C</td><td><span id='dremel-bed-temp-target'></span>°C</td></tr>
	      </table>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	    </div>
          </div><!-- col -->
        </div><!-- row -->

        <div class='row'>
          <div class='col'>
	    <h2>Slack</h2>
          </div><!-- col -->
          <div class='col'>
	    <h2><a href='graph.html?uuid=b2dbbde0-40e0-4bc6-80b3-fcd218f8a996'>IRC</a></h2>
            <ul id='irc' class='list-group list-group-flush'>
	    </ul>
          </div><!-- col -->
        </div><!-- row -->


      </div><!-- col-lg-8 -->
      <div class='col-lg-4 cameras-col'>
	<h2>Cameras</h2>
	<ul class='list-group'>
	  <li class='list-group-item'id='unit-1-window-container'><h4><a href='graph.html?uuid=736ec20e-1320-48c2-9a6b-2376f97e3d52'>Unit 1 Window</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item' id='unit-2-entrance-container'><h4><a href='graph.html?uuid=3b22ad64-3439-4e94-971f-13f055878dfb'>Unit 2 Entry</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item' id='unit-2-entry2-container'><h4><a href='graph.html?uuid=8401df69-1edf-4ac2-bd70-5076bf84c0be'>Unit 2 Entry 2</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item' id='slytherin-camera'><h4><a href='graph.html?uuid=fc4c1edb-c8e3-4771-9879-290358dbf746'>Slytherin</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item' id='unit-2-camera'><h4><a href='graph.html?uuid=03eca981-8a78-467f-868d-2af2159b34dd'>Unit 2</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item' id='electronics-lab-camera'><h4><a href='graph.html?uuid=3b22ad64-3439-4e94-971f-13f055878dfb'>Electronics Lab</a></h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item'><h4>Unit 3</h4>
	  <iframe src='https://video.nest.com/embedded/live/WdeSzuB41b?autoplay=1'>
	  </iframe>
	  </li>
	  <li class='list-group-item'><h4>Garden</h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	  <li class='list-group-item'><h4>Hydroponics</h4>
	    <img src='test-pattern.jpg' class='img-fluid img-thumbnail'>
	  </li>
	</ul>
	</div><!-- cameras-col -->
      </div><!- row />

      <div class='row'>
        <i>Want to hack this?</i> Source is at <a href='https://github.com/romkey/ctrlh-dashboard'>https://github.com/romkey/ctrlh-dashboard</a>
      </div>
  </div>
</div>

<!-- from https://www.cloudmqtt.com/docs/websocket.html -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js' type='text/javascript'></script>
<script src='https://code.jquery.com/jquery-3.2.1.slim.min.js' integrity='sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN' crossorigin='anonymous'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.6.7/jquery.timeago.min.js' integrity='sha384-bIExnxLHdrb4/5cUciUyC490hqkTPFw6V1eUbG0gpKQ67B3dsT6KOdXvl5RycCM6' crossorigin='anonymous'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js' integrity='sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q' crossorigin='anonymous'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js' integrity='sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl' crossorigin='anonymous'></script>
<script src='http://ctrlh.romkey.com/credentials.js'></script>
<script type='text/javascript'>
// we loaded the credentials in separate JS
// this is still not at all secure but it allows us to decouple management of this page and its content	    
// from management of the credentials, and lets us not check them into Github
// (despite the fact that they're flapping in the window here on the web)
// they should be for an account with read-only access only to the topic used for the hydroponics
//  var credentials = new CTLHProjectorMQTT();

client = new Paho.MQTT.Client(credentials.MQTT_SERVER, credentials.MQTT_PORT, credentials.MQTT_UUID + new Date().getTime());
client.onConnectionLost = onConnectionLost;
client.onMessageArrived = onMessageArrived;
mqtt_connect();

// cameras
var cameras = [
  { uuid: '3b22ad64-3439-4e94-971f-13f055878dfb', container: '#unit-2-entrance-container' },
  { uuid: '736ec20e-1320-48c2-9a6b-2376f97e3d52', container: '#unit-1-window-container' },
  { uuid: '8401df69-1edf-4ac2-bd70-5076bf84c0be', container: '#unit-2-entry2-container' },
  { uuid: 'fc4c1edb-c8e3-4771-9879-290358dbf746', container: '#slytherin-camera' },
  { uuid: '03eca981-8a78-467f-868d-2af2159b34dd', container: '#unit-2-camera' },
  { uuid: '6f971443-b685-4a2b-86fb-65522c0ab775', container: '#camera-6' },
  { uuid: 'c0603a32-7817-4922-b661-2a6be57b6bd0', container: '#dremel-cam' }
];

function onConnect() {
  console.log("onConnect");
  client.subscribe('/network/bandwidth'); 
  client.subscribe('/network/active_hosts');
//  client.subscribe('/furball');
  client.subscribe('/projectors'); 
  client.subscribe('/door'); 
  client.subscribe('/weather/current'); 
  client.subscribe('/printer'); 
  client.subscribe('/irc'); 
  client.subscribe('/aqi'); 

  // vendo
  client.subscribe('/homebus/device/4cf5765b-6a1a-4f05-879f-1285e092beb3');
  // Unit 2 furball 
  client.subscribe('/homebus/device/04001f9a-122b-4045-84f4-69b7c7318250'); 
  // Slytherin 
  client.subscribe('/homebus/device/067746e8-7a2f-4f6e-bb59-e1b2043b37f3');
  // Dremel
  client.subscribe('/homebus/devices/7bfff065-f2e8-406d-b8d1-734a84c4c222');

  cameras.forEach(function(item, index) {
    client.subscribe('/homebus/device/' + item["uuid"]);
    });
}

function mqtt_connect() {
  var options = {
    useSSL: false,
    userName: credentials.MQTT_USERNAME,
    password: credentials.MQTT_PASSWORD,
    onSuccess:onConnect,
    onFailure:doFail
  };

console.log("mqtt connect");
  client.connect(options); 
}


function doFail(e) {
  console.log(e);

console.log("doFail");

  mqtt_connect(); 
}

function onConnectionLost(responseObject) {
  if(responseObject.errorCode !== 0) {
    console.log("onConnectionLost:"+responseObject.errorMessage);
  }

console.log("connection lost");
  mqtt_connect(); 
}

// shamelessly taken from https://stackoverflow.com/questions/15900485/correct-way-to-convert-size-in-bytes-to-kb-mb-gb-in-javascript
function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';

  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}

function onMessageArrived(message) {
  $('hr').addClass('hr-green');
  setTimeout(function () {
    $('hr').removeClass('hr-green');
  }, 1000);

//  console.log('onMessageArrived:' + message.payloadString);
  console.log('topic is ' + message.destinationName);

  data = JSON.parse(message.payloadString);
  if(data["timestamp"])  {
    $('#last_updated_container').html(getTimeagostamp(data["timestamp"]));
    activateTimeago();
  }

  if(message.destinationName == '/network/bandwidth') 
    onNetworkBandwidth(message); 

  if(message.destinationName == '/network/active_hosts')
    onNetworkActive(message);

 if(message.destinationName == '/projectors') 
    onProjectors(message); 

 if(message.destinationName == '/door') 
    onDoor(message); 

 if(message.destinationName == '/weather/current') 
    onWeather(message); 

 if(message.destinationName == '/printer') 
    onPrinter(message); 

 if(message.destinationName == '/irc') 
    onIRC(message); 

 if(message.destinationName == '/aqi') 
    onAQI(message); 

  if(message.destinationName == '/homebus/device/4cf5765b-6a1a-4f05-879f-1285e092beb3')
    onVendo(message);

  if(message.destinationName == '/homebus/device/04001f9a-122b-4045-84f4-69b7c7318250')
    onFurball(message, "unit2"); 

  if(message.destinationName == '/homebus/device/067746e8-7a2f-4f6e-bb59-e1b2043b37f3')
    onFurball(message, "slytherin"); 

  if(message.destinationName == '/homebus/devices/7bfff065-f2e8-406d-b8d1-734a84c4c222')
    onDremel(message);

  cameras.forEach(function(item, index) {
    if(message.destinationName == '/homebus/device/' + item['uuid'])
      onCamera(message, item['container']);
  });
}


function onNetworkBandwidth(message) {
  var network = JSON.parse(message.payloadString);

  $("#network_rx").text(formatBytes(Number(network["bandwidth"]["rx_bps"])));
  $("#network_tx").text(formatBytes(Number(network["bandwidth"]["tx_bps"])));
}

function onNetworkActive(message) {
  var network = JSON.parse(message.payloadString);

  $("#network_active").text(network["active_hosts"]["arp_table_length"]);
}

function onFurball(message, unit) {
  var furball = JSON.parse(message.payloadString);

  $("#" + unit + "_temperature").text(furball["environment"]["temperature"]); 
  $("#" + unit + "_humidity").text(furball["environment"]["humidity"]); 
  $("#" + unit + "_occupied").text(furball["presence"] ? "y" : "n");
}

function onProjectors(message) {
  var projectors = JSON.parse(message.payloadString); 

  if(projectors["name"] == "Unit 2")
    id = "#unit2_projector_status";

  if(projectors["name"] == "Unit 3")
    id = "#unit3_projector_status";

  $(id).text(projectors["status"]);
}

function getTimeagostamp(timestamp) {
  var d = new Date(Number(timestamp)*1000); 
  return "<time class='timeago' datetime='" + d.toISOString() + "' title='" + d.toLocaleString() + "'></time>";
}

function activateTimeago() {
  $('.timeago').timeago(); 
}

function onDoor(message) {
  var door = JSON.parse(message.payloadString);
  var access = door["access"];

  if(!access || access["message"] ||onDoor.last_door_msg == message.payloadString)
    return;

console.log(onDoor.last_door_msg, message);
  onDoor.last_door_msg = message.payloadString;

  $("#access").prepend("<li class='list-group-item'>" + access["person"] + " " + access["action"] + " " + access["unit"] + " " + access["door"] + "<br/>" + getTimeagostamp(door["timestamp"]) + "</li>");
  activateTimeago(); 
}

function onWeather(message) {
  var w = JSON.parse(message.payloadString);

  $("#weather").html(w["weather"]["conditions_short"] + ": " + w["weather"]["temperature"] + "°C, " + w["weather"]["humidity"] + "%, " + w["weather"]["conditions_long"] + "<br/>" + getTimeagostamp(w["timestamp"]));
  activateTimeago(); 
}

function onPrinter(message) {
  var printer = JSON.parse(message.payloadString);
  var system = printer["system"];
  var status = printer["status"];

  $(".printer-name").text(system["model"]); 
  $(".printer-status").text(status["status"]); 
  $(".pages-printed").text(status["total_page_count"]);
}

function onIRC(message) {
  var msg = JSON.parse(message.payloadString);

  if(onIRC.last_irc_msg == message.payloadString)
    return;

console.log(onIRC.last_irc_msg, message.payloadString);

  onIRC.last_irc_msg = message.payloadString; 

  $('#irc').prepend("<li class='list-group-item'>" + msg["message"]["nick"] +  ": " + msg["message"]["message"] + "<br/>" + getTimeagostamp(msg["timestamp"]) + "</li>");
  activateTimeago(); 
}

function onAQI(message) {
  var msg = JSON.parse(message.payloadString); 
  var text = "";

  msg["observations"].forEach(function(item, index) {
  text += item["name"] + " AQI is " + item["aqi"] + " (" + item["condition"]  + ")<br />";
  });
  text +=  getTimeagostamp(msg["timestamp"]);
  $('#aqi').html(text);
  activateTimeago(); 
}

function onCamera(message, container) {
  var msg = JSON.parse(message.payloadString); 

  $(container + ' img').attr('src', 'data:' + msg['image']['mime_type'] + ';base64,' + msg['image']['data']);
  $(container + ' time').remove();
  $(container).append(getTimeagostamp(msg['timestamp']));
  activateTimeago();
}

function onVendo(message) {
  var msg = JSON.parse(message.payloadString); 

  $('#vendo-temperature').text(msg['environment']['temperature']); 
  $('#vendo-humidity').text(msg['environment']['humidity']); 
}

function onDremel(message) {
  var msg = JSON.parse(message.payloadString);

  console.log('onDremel');

  $('#dremel-status').text(msg['status']['state']);

  $('#dremel-filename').text(msg['job']['file']); 
  $('#dremel-progress').text(msg['job']['progress'].toFixed(2)); 
  $('#dremel-print-time').text(msg['job']['print_time']); 
  $('#dremel-print-time-remaining').text(msg['job']['print_time_remaining']); 

  if(msg['status']['state'] != 'idle')
    $('#dremel-job').show();

  $('#dremel-tool-temp').text(msg['temperatures']['tool0_actual']); 
  $('#dremel-tool-temp-target').text(msg['temperatures']['tool0_target']); 
  $('#dremel-bed-temp').text(msg['temperatures']['bed_actual']); 
  $('#dremel-bed-temp-target').text(msg['temperatures']['bed_target']); 
}
</script>

</body>
</html>
